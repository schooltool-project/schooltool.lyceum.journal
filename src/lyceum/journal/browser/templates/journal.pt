<html metal:use-macro="view/@@standard_macros/page" i18n:domain="lyceum">
<head>
  <title metal:fill-slot="title"
         i18n:translate="">
    <tal:block i18n:name="section" tal:replace="view/context/section/label" /> journal  for
    <tal:block i18n:name="month" tal:replace="python: view.monthTitle(view.active_month)" /></title>

  <title  i18n:translate=""
    ><span i18n:name="section" tal:replace="view/context/section/label"/> journal</title>
</head>

<metal:block metal:fill-slot="content-header">
    <h1 i18n:translate=""><tal:block i18n:name="section" tal:replace="view/context/section/label" /> journal  for <tal:block i18n:name="month" tal:replace="python: view.monthTitle(view.active_month)" /></h1>
</metal:block>

<metal:block metal:fill-slot="body">
  <script language="javascript">
    var selected_cell = null;

    function unselectCell() {
        if (selected_cell) {
          var cell = selected_cell;
          var grade = $("#grade")[0].value;
          $.ajax({
             url: 'ajax.xml',
             type: 'POST',
             timeout: 1000,
             data: {event_id: cell.event_id,
                    person_id: cell.person_id,
                    grade: grade},
             error: function() {
               $(cell).removeClass('ajaxinprogress');
               $(cell).addClass('ajaxerror')
             },
             success: function(xml){
               $(cell).removeClass('ajaxinprogress');
               $(cell).addClass('ajaxsuccess');
             }
          });
          $("#grade_container").html($("#grade"));
          $(selected_cell).html(grade);
          $(selected_cell).addClass('ajaxinprogress')
          .removeClass('ajaxerror')
          .removeClass('ajaxsuccess');
          selected_cell = null;
        }
    }

    function selectCell(cell) {
      unselectCell();
      var value = $.trim(cell.textContent);
      $(cell).html($("#grade"));
      $("#grade")[0].value = value;
      $("#grade").focus().select();
      selected_cell = cell;
    }

    $(document).ready(function(){

      $("#grade").blur(function () {
        unselectCell();
      });

      $(".data").click(function(event){
         if (event.target.person_id &&
             event.target.event_id)
         {
           if (selected_cell != event.target) {
             selectCell(event.target);
             return false;
           }
         }
      });

      $(document).keypress(function (event) {
        if (event.keyCode == 9 && selected_cell) {
          index = selected_cell.cellIndex;
          tr = selected_cell.parentNode;

          next_tr = null;
          if (event.shiftKey) {
            next_tr = tr.previousSibling.previousSibling;
          }
          else {
            next_tr = tr.nextSibling.nextSibling;
          }

          if (!next_tr) return true;

          new_td = next_tr.getElementsByTagName('td')[index];

          var inputs = $(new_td).children('INPUT');
          if (inputs.size()) {
            unselectCell();
            $(inputs[0]).focus().select();
            return false;
          }

          selectCell(new_td);
          return false;
        }
        if (event.keyCode == 27 && selected_cell) {
          unselectCell();
          return false;
        }
        if (event.keyCode == 13 && selected_cell) {
          unselectCell();
          return false;
        }
        return true
      })

      table = $('.data')[0];
      rows = table.getElementsByTagName('tr');
      var event_ids = Array();
      for (var i = 0; i < rows.length; i++) {
        row = rows[i];
        if (i == 0) {
          cells = row.getElementsByTagName('th');
          for (var j = 0; j < cells.length; j++) {
            cell = cells[j];

            inputs = $(cells[j]).children(".event_id");
            if (inputs.length > 0) {
              event_ids[j] = inputs[0].value;
            }
          }
        }
        else
        {
          cells = row.getElementsByTagName('td');
          var person_id = null;
          if (cells.length > 0) {
            inputs = $(cells[0]).children(".person_id");
            if (inputs.length > 0) {
              person_id = inputs[0].value;
            }
          }
          for (var j = 0; j < cells.length; j++) {
            cell = cells[j];
            cell.person_id = person_id;
            cell.event_id = event_ids[j];
          }
        }
      }

      $(".data INPUT").blur(function () {
          var cell = this.parentNode;
          var grade = $.trim(this.value);
          var input = this;
          $.ajax({
             url: 'ajax.xml',
             type: 'POST',
             timeout: 1000,
             data: {event_id: cell.event_id,
                    person_id: cell.person_id,
                    grade: grade},
             error: function() {
               $(input).css('background', '#FFAAAA');
             },
             success: function(xml){
               $(input).css('background', '#AAFFAA');
             }
          });
          $(this).css('background', '#AAAAFF');
      });

    });
  </script>
  <form action="." method="post" tal:attributes="action request/URL">
    <div name="grade_container" id="grade_container" style="display: None;"><input id="grade" name="grade" type="text" style="width: 1.4em" /></div>
    <select name="TERM">
      <option tal:repeat="term view/scheduled_terms"
              tal:content="term/title"
              tal:attributes="value term/__name__;
                              selected python:term is view.getSelectedTerm()" />
    </select>

    <input tal:condition="request/month|nothing"
           type="hidden"
           name="month"
           tal:attributes="value request/month" />
    <input tal:condition="request/event_id|nothing"
           type="hidden"
           name="event_id"
           tal:attributes="value request/event_id" />
    <input tal:condition="request/student|nothing"
           type="hidden"
           name="student"
           tal:attributes="value request/student" />

    <div>
      <span tal:repeat="month_id view/monthsInSelectedTerm">
        <tal:if condition="python: month_id != view.active_month">
          <a tal:attributes="href python: view.monthURL(month_id)"
             tal:content="python: view.monthTitle(month_id)" />
        </tal:if>
        <tal:if condition="python: month_id == view.active_month">
          <tal:block tal:replace="python: view.monthTitle(month_id)" />
        </tal:if>
      </span>
      <span>
        <a tal:attributes="href string:${context/@@absolute_url}/term_grades.html"
           i18n:translate="">Term Grading</a>
      </span>
    </div>

    <div class="gradebook">
      <tal:block replace="structure view/gradebook/render" />
    </div>

    <div class="controls">
      <input type="submit" class="button-ok" name="UPDATE_SUBMIT" value="Update"
             title="Shortcut: Alt-U" accesskey="U"
             i18n:attributes="value update-button; accesskey" />
      <input type="submit" class="button-cancel" name="CANCEL" value="Cancel"
             i18n:attributes="value cancel-button" />
    </div>

  </form>
</metal:block>
</html>
