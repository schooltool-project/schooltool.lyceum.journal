<html metal:use-macro="view/@@standard_macros/page" i18n:domain="schooltool.lyceum.journal">
<head>
  <title metal:fill-slot="title"
         i18n:translate="">
      <tal:block i18n:name="section" tal:replace="view/context/section/label" />
      journal for <tal:block i18n:name="month" tal:replace="python: view.monthTitle(view.active_month)" /> <tal:block i18n:name="year" tal:replace="view/active_year" /></title>

  <title  i18n:translate=""
    ><span i18n:name="section" tal:replace="view/context/section/label"/> journal</title>
</head>

<tal:block metal:fill-slot="extrahead">
  <!--[if !IE]>-->
    <link type="text/css" rel="stylesheet" href="journal_non_ie.css"
          tal:attributes="href context/++resource++journal_non_ie.css" />
  <!--<![endif]-->
  <script language="javascript">
    var selected_cell = null;
    var old_grade = null;
    var grade = null;

    function saveLessonDescription(input, event_id) {
        console.log(input.value)
        $.ajax({
           url: 'setLessonDescription.xml',
           type: 'POST',
           timeout: 5000,
           data: {event_id: event_id,
                  lesson_description: input.value},
           error: function() {},
           success: function(xml){}
        });
    }

    function unselectCell() {
        if (selected_cell) {
          var cell = selected_cell;

          if (grade != old_grade) {
            $.ajax({
               url: 'ajax.xml',
               type: 'POST',
               timeout: 5000,
               data: {event_id: cell.event_id,
                      person_id: cell.person_id,
                      grade: grade},
               error: function() {
                 $(cell).css('background', '#FFAAAA');
                 cell.modified_failure = true;
               },
               success: function(xml){
                 $(cell).css('background', '#AAFFAA');
                 cell.modified_success = true;
               }
            });
          }
          $(cell).removeClass('selected-cell');

          selected_cell = null;
          old_grade = null;
          grade = null;
        }
    }

    function selectCell(cell) {
      unselectCell();
      //var value = $.trim(cell.textContent);
      var value = $.trim(cell.innerHTML);
      old_grade = value;
      grade = value;
      $(cell).addClass('selected-cell');
      selected_cell = cell;
    }

    $(document).ready(function(){

      $(".data").click(function(event){
         if (event.target.person_id &&
             event.target.event_id)
         {
             if (selected_cell != event.target) {
               selectCell(event.target);
               return false;
             }
         }
      });

      $(".select-column").click(function(event){
        var cell_index = this.parentNode.cellIndex;

        $(".gradebook .data .selected-column").removeClass('selected-column');
        $(".gradebook .data .selected-row").removeClass('selected-row');

        $(".gradebook .data TR").each(function (index) {
           var cell = this.getElementsByTagName('td')[cell_index];
           if (cell) {
             $(cell).addClass("selected-column");
           }
        });


        var event_id = null;
        var inputs = $(event.target.parentNode).children(".event_id");
        if (inputs.length > 0) {
           event_id = inputs[0].value;
        }

        $.ajax({
           url: 'getLessonDescription.xml',
           type: 'POST',
           timeout: 5000,
           data: {event_id: event_id},
           error: function() {},
           success: function(xml){
               $('.lesson-description').html(xml);
           }
        });

        return false;
      });

      $(".select-column").each(function (index) {
        $(this).css('cursor', 'pointer');
        if ($(this).children().length > 0) {
          $(this).html($($(this).children()[0]).html());
        }
      });

      $(".select-row").click(function (event) {
        $(".gradebook .data .selected-column").removeClass('selected-column');
        $(".gradebook .data .selected-row").removeClass('selected-row');

        $(event.target.parentNode.parentNode).children("TD").each(function (index) {
           if (this.event_id && this.person_id) {
             $(this).addClass("selected-row");
           }
        });

        return false;
      });

      $(document).keydown(function (event) {
        if (selected_cell && !event.ctrlKey && !event.altKey) {
          if (event.keyCode == 37) { // left
            index = selected_cell.cellIndex;
            tr = selected_cell.parentNode;
            new_td = tr.getElementsByTagName('td')[index-1];
            if (new_td.event_id && new_td.person_id) {
              selectCell(new_td);
              return false;
            }
          }

          if (event.keyCode == 38) { // up
            index = selected_cell.cellIndex;
            tr = selected_cell.parentNode;

            next_tr = null;
            next_tr = tr.previousSibling;
            if (next_tr.nodeName != 'TR')
              next_tr = next_tr.previousSibling;

            if (!next_tr) return true;

            new_td = next_tr.getElementsByTagName('td')[index];

            if (new_td.event_id && new_td.person_id) {
              selectCell(new_td);
              return false;
            }
          }

          if (event.keyCode == 39) { // right
            index = selected_cell.cellIndex;
            tr = selected_cell.parentNode;

            new_td = tr.getElementsByTagName('td')[index+1];

            if (new_td.event_id && new_td.person_id) {
              selectCell(new_td);
              return false;
            }
          }

          if (event.keyCode == 40) { // down
            index = selected_cell.cellIndex;
            tr = selected_cell.parentNode;

            next_tr = tr.nextSibling;
            if (next_tr.nodeName != 'TR')
              next_tr = next_tr.nextSibling;

            if (!next_tr) return true;

            new_td = next_tr.getElementsByTagName('td')[index];
            if (new_td.event_id && new_td.person_id) {
              selectCell(new_td);
              return false;
            }
          }

          if (event.keyCode == 8 || event.keyCode == 46) { // Backspace, Del
            grade = '';
            $(selected_cell).html(grade);
            return false;
          }
        }
      });

      $(document).keypress(function (event) {
        if (selected_cell && !event.ctrlKey && !event.altKey) {
          if (event.keyCode == 13) { // enter
            var selection = $(".selected-column");
            var selected_rows = $(".selected-row");

            if (selected_rows.length > selection.length) {
              selection = selected_rows;
            }

            var item = 0;
            if (selection.length != 0) {
              selection.each(function (index) {
                if (this == selected_cell) {
                  item = index + 1;
                }
              });
              unselectCell();
              if (item < selection.length)
                selectCell(selection[item]);
            } else {
              unselectCell();
            }
            return false;
          }

          if (event.keyCode == 27) { // esc
            grade = old_grade;
            $(selected_cell).html(grade);
            unselectCell();
            return false;
          }

          if (event.charCode == 32 || event.keyCode == 32) { // Space
            grade = '';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 49 || event.keyCode == 49) { // 1
            grade = '1';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 50 || event.keyCode == 50) { // 2
            grade = '2';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 51 || event.keyCode == 51) { // 3
            grade = '3';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 52 || event.keyCode == 52) { // 4
            grade = '4';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 53 || event.keyCode == 53) { // 5
            grade = '5';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 54 || event.keyCode == 54) { // 6
            grade = '6';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 55 || event.keyCode == 55) { // 7
            grade = '7';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 56 || event.keyCode == 56) { // 8
            grade = '8';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 57 || event.keyCode == 57) { // 9
            grade = '9';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 48 || event.keyCode == 48) { // 0
            grade = '10';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 78 || event.charCode == 110 || event.keyCode == 78  || event.keyCode == 110) { // N, n
            grade = 'n';
            $(selected_cell).html(grade);
            return false;
          }

          if (event.charCode == 80 || event.charCode == 112 || event.keyCode == 80 || event.keyCode == 112) { // P, p
            grade = 'p';
            $(selected_cell).html(grade);
            return false;
          }

        }
        return true;
      });

      table = $('.data')[0];
      rows = table.getElementsByTagName('tr');
      var event_ids = Array();
      for (var i = 0; i < rows.length; i++) {
        row = rows[i];
        if (i == 0) {
          cells = row.getElementsByTagName('th');
          for (var j = 0; j < cells.length; j++) {
            cell = cells[j];

            inputs = $(cells[j]).children(".event_id");
            if (inputs.length > 0) {
              event_ids[j] = inputs[0].value;
            }
          }
        }
        else
        {
          cells = row.getElementsByTagName('td');

          var person_id = null;
          if (cells.length > 0) {
            inputs = $(cells[0]).children(".person_id");
            if (inputs.length > 0) {
              person_id = inputs[0].value;
            }
          }
          for (var j = 0; j < cells.length; j++) {
            cell = cells[j];
            cell.person_id = person_id;
            cell.event_id = event_ids[j];
          }
        }
      }

      $(".data INPUT").each(function (index) {
        if (this.type == 'text') {
          $(this.parentNode).html(this.value);
        }
      });

    });
  </script>
</tal:block>

<metal:block metal:fill-slot="content-header">
    <h1 i18n:translate="">
      <tal:block i18n:name="section" tal:replace="view/context/section/label" />
      journal for <tal:block i18n:name="month" tal:replace="python: view.monthTitle(view.active_month)" /> <tal:block i18n:name="year" tal:replace="view/active_year" /></h1>
</metal:block>

<metal:block metal:fill-slot="body">
  <form action="." method="post" tal:attributes="action request/URL">

    <div class="lesson-description">
      <tal:block condition="request/event_id|nothing"
                 define="meeting view/selectedEvent">
        <div>Lesson description for <tal:block content="meeting/dtstart/@@shortDate" /> period <tal:block content="meeting/period_id" /></div>
        <textarea tal:attributes="onBlur string:saveLessonDescription(this, '${view/encodedSelectedEventId}')"
                  name="lesson_description" cols="100" rows="6" tal:content="view/selectedEventLessonDescription"></textarea>
      </tal:block>
    </div>

    <input tal:condition="request/month|nothing"
           type="hidden"
           name="month"
           tal:attributes="value request/month" />
    <input tal:condition="request/event_id|nothing"
           type="hidden"
           name="event_id"
           tal:attributes="value request/event_id" />
    <input tal:condition="request/student|nothing"
           type="hidden"
           name="student"
           tal:attributes="value request/student" />

    <div>
      <span tal:repeat="month_id view/monthsInSelectedTerm">
        <tal:if condition="python: month_id != view.active_month">
          <a tal:attributes="href python: view.monthURL(month_id)"
             tal:content="python: view.monthTitle(month_id)" />
        </tal:if>
        <tal:if condition="python: month_id == view.active_month">
          <tal:block tal:replace="python: view.monthTitle(month_id)" />
        </tal:if>
      </span>
      <span>
        <a tal:attributes="href string:${context/@@absolute_url}/term_grades.html"
           i18n:translate="">Term Grading</a>
      </span>
    </div>

    <div class="gradebook">
      <tal:block replace="structure view/gradebook/render" />
    </div>

    <div class="controls">
      <tal:block metal:use-macro="view/@@standard_macros/update-button" />
    </div>

  </form>
</metal:block>
</html>
